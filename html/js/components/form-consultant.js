const provinces = {
    status: 1,
    total: 64,
    message: "Danh sách Tỉnh/Thành phố",
    data: [
        {
            id: 1,
            title: "An Giang",
        },
        {
            id: 2,
            title: "Bà Rịa - Vũng Tàu",
        },
        {
            id: 3,
            title: "Bình Dương",
        },
        {
            id: 4,
            title: "Bình Phước",
        },
        {
            id: 5,
            title: "Bình Thuận",
        },
        {
            id: 6,
            title: "Bình Định",
        },
        {
            id: 7,
            title: "Bắc Giang",
        },
        {
            id: 8,
            title: "Bắc Kạn",
        },
        {
            id: 9,
            title: "Bắc Ninh",
        },
        {
            id: 10,
            title: "Bến Tre",
        },
        {
            id: 11,
            title: "Cao Bằng",
        },
        {
            id: 12,
            title: "Cà Mau",
        },
        {
            id: 13,
            title: "Cần Thơ",
        },
        {
            id: 14,
            title: "Gia Lai",
        },
        {
            id: 15,
            title: "Hà Giang",
        },
        {
            id: 16,
            title: "Hà Nam",
        },
        {
            id: 17,
            title: "Hà Nội",
        },
        {
            id: 18,
            title: "Hà Tây",
        },
        {
            id: 19,
            title: "Hà Tĩnh",
        },
        {
            id: 20,
            title: "Hòa Bình",
        },
        {
            id: 21,
            title: "Hưng Yên",
        },
        {
            id: 22,
            title: "Hải Dương",
        },
        {
            id: 23,
            title: "Hải Phòng",
        },
        {
            id: 24,
            title: "Hồ Chí Minh",
        },
        {
            id: 25,
            title: "Khánh Hòa",
        },
        {
            id: 27,
            title: "Kiên Giang",
        },
        {
            id: 28,
            title: "Kon Tum",
        },
        {
            id: 29,
            title: "Lai Châu",
        },
        {
            id: 30,
            title: "Long An",
        },
        {
            id: 31,
            title: "Lào Cai",
        },
        {
            id: 32,
            title: "Lâm Đồng",
        },
        {
            id: 33,
            title: "Lạng Sơn",
        },
        {
            id: 34,
            title: "Nam Định",
        },
        {
            id: 35,
            title: "Nghệ An",
        },
        {
            id: 36,
            title: "Ninh Bình",
        },
        {
            id: 37,
            title: "Ninh Thuận",
        },
        {
            id: 38,
            title: "Phú Thọ",
        },
        {
            id: 39,
            title: "Phú Yên",
        },
        {
            id: 40,
            title: "Quảng Bình",
        },
        {
            id: 41,
            title: "Quảng Nam",
        },
        {
            id: 42,
            title: "Quảng Ngãi",
        },
        {
            id: 43,
            title: "Quảng Ninh",
        },
        {
            id: 44,
            title: "Quảng Trị",
        },
        {
            id: 45,
            title: "Sơn La",
        },
        {
            id: 46,
            title: "Thanh Hóa",
        },
        {
            id: 47,
            title: "Thái Bình",
        },
        {
            id: 48,
            title: "Thái Nguyên",
        },
        {
            id: 49,
            title: "Thừa Thiên Huế",
        },
        {
            id: 50,
            title: "Tiền Giang",
        },
        {
            id: 51,
            title: "Trà Vinh",
        },
        {
            id: 52,
            title: "Tuyên Quang",
        },
        {
            id: 53,
            title: "Tây Ninh",
        },
        {
            id: 54,
            title: "Vĩnh Long",
        },
        {
            id: 55,
            title: "Vĩnh Phúc",
        },
        {
            id: 56,
            title: "Yên Bái",
        },
        {
            id: 57,
            title: "Đà Nẵng",
        },
        {
            id: 58,
            title: "Đắk Lắk",
        },
        {
            id: 59,
            title: "Đồng Nai",
        },
        {
            id: 60,
            title: "Đồng Tháp",
        },
        {
            id: 61,
            title: "Bạc Liêu",
        },
        {
            id: 62,
            title: "Sóc Trăng",
        },
        {
            id: 63,
            title: "Hậu Giang",
        },
        {
            id: 64,
            title: "Đắk Nông",
        },
        {
            id: 66,
            title: "Điện Biên",
        },
    ],
};

const districts = {
    status: 1,
    total: 24,
    message: "Danh sách quận/huyện",
    data: [
        {
            id: 466,
            title: "Quận 1",
        },
        {
            id: 467,
            title: "Quận 2",
        },
        {
            id: 468,
            title: "Quận 3",
        },
        {
            id: 469,
            title: "Quận 4",
        },
        {
            id: 470,
            title: "Quận 5",
        },
        {
            id: 471,
            title: "Quận 6",
        },
        {
            id: 472,
            title: "Quận 7",
        },
        {
            id: 473,
            title: "Quận 8",
        },
        {
            id: 474,
            title: "Quận 9",
        },
        {
            id: 475,
            title: "Quận 10",
        },
        {
            id: 476,
            title: "Quận 11",
        },
        {
            id: 477,
            title: "Quận 12",
        },
        {
            id: 478,
            title: "Quận Gò Vấp",
        },
        {
            id: 479,
            title: "Quận Tân Bình",
        },
        {
            id: 480,
            title: "Quận Bình Thạnh",
        },
        {
            id: 481,
            title: "Quận Phú Nhuận",
        },
        {
            id: 482,
            title: "Thành phố Thủ Đức",
        },
        {
            id: 483,
            title: "Huyện Củ Chi",
        },
        {
            id: 484,
            title: "Huyện Hóc Môn",
        },
        {
            id: 485,
            title: "Huyện Bình Chánh",
        },
        {
            id: 486,
            title: "Huyện Nhà Bè",
        },
        {
            id: 487,
            title: "Huyện Cần Giờ",
        },
        {
            id: 679,
            title: "Quận Bình Tân",
        },
        {
            id: 680,
            title: "Quận Tân Phú",
        },
    ],
};

// const baseApiUrl = "http://localhost:8074/api/WEB/";
const baseApiUrl = "http://127.0.0.1:4005/apis/v1/";
const baseImgUrl = "https://cms.hpv.vn/api/CMS/image/folder/";

const apiRequest = {
    async getDistrict(idProvince) {
        return fetch(`${baseApiUrl}district`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ province_id: idProvince }),
        })
            .then((response) => {
                return response.json();
            })
            .catch(() => {
                return null;
            });
    },
    async getProvinces() {
        return fetch(`${baseApiUrl}province`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
        })
            .then((response) => {
                return response.json();
            })
            .then((data) => data.data)
            .catch(() => {
                return null;
            });
    },
    async getListConsultantLocation(query) {
        return fetch(`${baseApiUrl}consultant-locations`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(query),
        })
            .then((response) => {
                return response.json();
            })
            .then((data) => data)
            .catch(() => {
                apiRequest.isGetFullLocation = true;
                return null;
            });
    },
    async getConsultantLocationDetails(idLocation) {
        return fetch(`${baseApiUrl}consultant-location`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ consult_location_id: idLocation }),
        })
            .then((response) => {
                return response.json();
            })
            .then((data) => data)
            .catch(() => {
                return null;
            });
    },
    loading: {
        searchConsultantLocation: false,
        findConsultantLocation: false,
    },
    isGetFullLocation: false,
};

const domElements = {
    formSearch: {
        form() {
            return document.querySelector("form.form-input");
        },
        address() {
            return this.form().querySelector("input[name='address']");
        },
    },
    listConsultant: {
        container: function () {
            return document.querySelector(
                ".consultant-locations-list#consultant-locations-list"
            );
        },
        loading() {
            return this.container().querySelector(".loading");
        },
        emptyState() {
            return this.container().querySelector(".empty-state");
        },
        listLocation() {
            return this.container().querySelector(".consultant-locations");
        },
    },
    googleMap: {
        container: function () {
            return document.querySelector(".google-map#google-map");
        },
        iframe() {
            console.log("🚀 ~ iframe ~ this.googleMap:", this.container());
            return this.container().querySelector("iframe");
        },
        loading() {
            return this.container().querySelector(".loading");
        },
    },
    infoLocationDetails: {
        container() {
            return document.querySelector(
                ".locations-details#locations-details"
            );
        },
        locationThumb() {
            return this.container().querySelector(".thumb img");
        },
        locationName() {
            return this.container().querySelector(".location-details__name");
        },
        addressText() {
            return this.container().querySelector(".address__text");
        },
        phoneNumber() {
            return this.container().querySelector(".phone-number__text");
        },
        workingHour() {
            return this.container().querySelector(".working-hour__text");
        },
        btnDirection() {
            return this.container().querySelector(".btn-directions");
        },
        btnGoBack() {
            return this.container().querySelector(".btn-og-back");
        },
    },
    modalConsultantLocationDetails() {
        return document.querySelector(".modal-consultant-location-details");
    },
    btnCloseModal() {
        return document.querySelector(".btn-close-modal");
    },
};

function eventDropdowns(inputControl, form) {
    const dropdownToggle = inputControl.querySelector(".dropdown-toggle");
    const dropdownMenu = inputControl.querySelector(".dropdown-menu");

    dropdownToggle.addEventListener("click", function (e) {
        e.preventDefault();
        const allDropDownMenu = form.querySelectorAll(".dropdown-menu");
        allDropDownMenu.forEach((menu) => {
            if (menu !== dropdownMenu) {
                menu.style.display = "none";
            }
        });

        dropdownMenu.style.display =
            dropdownMenu.style.display !== "none" ? "none" : "flex";
    });
    document.addEventListener("click", function (e) {
        if (!e.target.closest(".dropdown")) {
            dropdownMenu.style.display = "none";
        }
    });
}

function renderDropDown(form, idDropdown, data, callBack) {
    const inputControl = form.querySelector(`#${idDropdown}`);
    const selectValue = inputControl.querySelector(".select-value");
    const inputCity = inputControl.querySelector(`input[name="${idDropdown}"]`);
    const cityList = inputControl.querySelector(`.dropdown-menu`);
    cityList.innerHTML = null;

    data.forEach((pr) => {
        const li = document.createElement("li");
        li.textContent = pr.title;
        li.dataset.value = pr.title;
        li.classList.add("dropdown-item");
        li.addEventListener("click", () => {
            selectValue.textContent = pr.title;
            inputCity.value = pr.id;
            cityList.style.display = "none";
            if (callBack) {
                callBack(pr.id);
            }
        });
        cityList.appendChild(li);
    });
}

// async function getListConsultantLocation(query) {
//     return new Promise((resolve, reject) => {
//         setTimeout(() => {
//             resolve(
//                 fetch(`${baseApiUrl}consultant-locations`, {
//                     method: "POST",
//                     headers: {
//                         "Content-Type": "application/json",
//                     },
//                     body: JSON.stringify(query),
//                 })
//                     .then((response) => {
//                         return response.json();
//                     })
//                     .then((data) => data)
//                     .catch(() => {
//                         apiRequest.isGetFullLocation = true;
//                         return null;
//                     })
//             );
//         }, 1200);
//     });
// }

async function updateDistrict(form, idProvince) {
    const districts = await apiRequest.getDistrict(idProvince);

    const selectValue = form.querySelector("#district .select-value");
    const inputCity = form.querySelector(`#district input[name="district"]`);

    selectValue.textContent = "Huyện/Quận";
    inputCity.value = 0;

    if (districts) {
        renderDropDown(form, "district", districts.data);
    } else {
        Toastify({
            text: "Lỗi không thể tải được danh sách Quận/Huyện.",
            className: "error msd",
            duration: 2500,
            close: true,
            gravity: "top", // `top` or `bottom`
            stopOnFocus: true,
        }).showToast();
    }
}

async function onClickLocationItem(idLocation) {
    const locationDetails = await apiRequest.getConsultantLocationDetails(
        idLocation
    );
    if (window.innerWidth <= 975) {
        const modalConsultantLocationDetails =
            domElements.modalConsultantLocationDetails();
        if (modalConsultantLocationDetails) {
            modalConsultantLocationDetails.style.display = "flex";
            setTimeout(() => {
                modalConsultantLocationDetails.classList.add("active");
            }, 50);
        }
    }
    updateConsultantLocationDetails(locationDetails.data);
}

async function renderListConsultantLocation(locations, isPushMore = false) {
    const listConsultLocation = domElements.listConsultant.container();
    if (listConsultLocation) {
        const listEl = listConsultLocation.querySelector(
            ".consultant-locations"
        );
        if (!isPushMore) listEl.innerHTML = "";

        locations.forEach((l) => {
            const article = document.createElement("article");
            article.classList.add("location");
            article.addEventListener("click", () => onClickLocationItem(l.id));
            const html = `
                <div class="location__thumb">
                    <img src="${baseImgUrl}${l.img_mobile}" alt="${l.name}" />
                </div>
                <div class="location__info">
                    <h3 class="location__info__name">
                        ${l.name}
                    </h3>
                    <address class="location__info__address">
                        <svg class="address__icon" aria-hidden="true" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7m0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5">
                        </path>
                        </svg>
                        <p class="address__text">${l.address}</p>
                    </address>
                </div>
                `;
            article.innerHTML = html;
            listEl.appendChild(article);
        });
    }
}

function getPageOffsetListLocation() {
    const listConsultLocation = domElements.listConsultant.listLocation();
    if (listConsultLocation) {
        return parseInt(listConsultLocation.dataset.pageOffset);
    }
    return 0;
}
function setPageOffsetListLocation(value) {
    const listConsultLocation = domElements.listConsultant.listLocation();
    if (listConsultLocation) {
        listConsultLocation.dataset.pageOffset = value;
    }
}

async function handleFindConsultantLocation(form, isFindMore = false) {
    apiRequest.isGetFullLocation = false;

    const emptyState = domElements.listConsultant.emptyState();
    emptyState.style.display = "none";

    const fromData = form ? new FormData(form) : null;
    const pageOffset = isFindMore ? getPageOffsetListLocation() + 20 : 0;

    let payload;
    if (fromData) {
        payload = {
            lat: 0,
            lng: 0,
            province: fromData.get("city") ? parseInt(fromData.get("city")) : 0,
            district: fromData.get("district")
                ? parseInt(fromData.get("district"))
                : 0,
            name_or_address: fromData.get("address"),
            limit: 20,
            offset: pageOffset,
        };
    } else {
        payload = {
            lat: 0,
            lng: 0,
            province: 0,
            district: 0,
            name_or_address: "",
            limit: 20,
            offset: 0,
        };
    }

    const loading = domElements.listConsultant.loading();
    loading.style.display = "block";
    apiRequest.loading.findConsultantLocation = true;
    const listLocations = await apiRequest.getListConsultantLocation(payload);
    loading.style.display = "none";
    apiRequest.loading.findConsultantLocation = false;

    if (listLocations) {
        setPageOffsetListLocation(isFindMore ? pageOffset : 0);
        renderListConsultantLocation(listLocations.data, isFindMore);
        if (listLocations.data.length === 0) {
            emptyState.style.display = "block";
        }
    } else {
        if (!pageOffset) {
            renderListConsultantLocation([]);
            emptyState.style.display = "block";
        }
    }
}

function handleScrollListConsultantLocation() {
    if (apiRequest.isGetFullLocation) return;
    const locations = domElements.listConsultant
        .listLocation()
        .querySelectorAll(".location");
    const penultimateLocation = locations[locations.length - 4];
    if (
        penultimateLocation &&
        penultimateLocation.getBoundingClientRect().bottom <= window.innerHeight
    ) {
        handleFindConsultantLocation(domElements.formSearch.form(), true);
    }
}

function updateGoogleMap(locationData) {
    const googleMap = domElements.googleMap.container();
    if (googleMap) {
        if (locationData?.urlEmbed) {
            googleMap.innerHTML = locationData.urlEmbed.replace(
                "<iframe ",
                `<iframe width="100%" height="100%"`
            );
        } else {
            const urlEmbed = `https://maps.google.com/maps?q=${locationData.lat},${locationData.lng}&hl=vn&z=17&amp;output=embed`;
            googleMap.innerHTML = `
                <div class="loading" style="display: block;">
                    <div class="msd-loader-container">
                        <div class="msd-loader"></div>
                    </div>
                </div>
                <iframe
                src="${urlEmbed}"
                width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"></iframe>
            `;
        }

        const iframe = googleMap.querySelector("iframe");
        const loading = domElements.googleMap.loading();
        loading.style.display = "block";
        iframe.addEventListener("load", () => {
            loading.style.display = "none";
        });
    }
}

async function updateConsultantLocationDetails(locationData) {
    const infoLocationDetails = domElements.infoLocationDetails;
    infoLocationDetails.locationThumb().src =
        baseImgUrl + locationData.img_mobile;
    infoLocationDetails.locationName().textContent = locationData.name;
    infoLocationDetails.addressText().textContent = locationData.address;
    infoLocationDetails.phoneNumber().textContent = locationData.phone;
    infoLocationDetails.workingHour().textContent = locationData.operation;
    infoLocationDetails.btnDirection().href =
        locationData?.dirLink ||
        `https://maps.google.com/maps?q=${locationData.lat},${locationData.lng}`;
    infoLocationDetails.btnDirection().title = locationData.name;

    updateGoogleMap(locationData);
}

function closeModalConsultantDetails() {
    const modalConsultantLocationDetails =
        domElements.modalConsultantLocationDetails();
    if (modalConsultantLocationDetails) {
        modalConsultantLocationDetails.classList.remove("active");
        setTimeout(() => {
            modalConsultantLocationDetails.style.display = "none";
        }, 300);
    }
}

async function initForm() {
    const form = domElements.formSearch.form();
    const inputAddress = domElements.formSearch.address();
    if (form) {
        form.addEventListener("submit", (e) => {
            e.preventDefault();
        });
        renderDropDown(form, "city", provinces.data, (idProvince) => {
            updateDistrict(form, idProvince);
        });
        eventDropdowns(form.querySelector("#city"), form);
        eventDropdowns(form.querySelector("#district"), form);

        const btnSearch = form.querySelector("#btn-find-now");
        btnSearch.addEventListener("click", () =>
            handleFindConsultantLocation(form)
        );
    }
    if (inputAddress) {
        inputAddress.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === 13) {
                handleFindConsultantLocation(form);
                e.preventDefault();
            }
        });
    }
}

function initListConsultantLocation() {
    const btnGoBack = domElements.infoLocationDetails.btnGoBack();
    const btnClose = domElements.btnCloseModal();

    if (btnGoBack && btnClose) {
        btnGoBack.addEventListener("click", closeModalConsultantDetails);
        btnClose.addEventListener("click", closeModalConsultantDetails);
    }

    const consultantLocation = domElements.listConsultant.container();
    consultantLocation.addEventListener("scroll", () => {
        if (apiRequest.loading.findConsultantLocation) return;
        handleScrollListConsultantLocation();
    });
}

if (document.readyState !== "loading") {
    initForm();
    handleFindConsultantLocation(null, false);
    initListConsultantLocation();
} else {
    document.addEventListener("DOMContentLoaded", function () {
        initForm();
        initListConsultantLocation();
        handleFindConsultantLocation(null, false);
        // window.addEventListener("scroll", handleScrollListConsultantLocation);
    });
}
